<div style="position: absolute; top: 5px, left: 5px">
    <a href="/products" >Back</a>
</div>
<h1 style="text-align: center;">CARRITO</h1>
<div style="width: 100%;display: grid;grid-template-columns: repeat(auto-fit,minmax(340px,1fr));gap: 10px;">
    {{#each data.products}}
        <div style="position:relative; border: gray 1px solid; width: 320px;border-radius: 10px;padding: 8px;" class="form-div-{{@index}}">
            <h2 style="text-align: center;text-transform: uppercase;">{{this.product.title}} </h2>
            <p> <b>Descripcion</b>: {{this.product.description}} </p>
            <div style="display: flex; flex-direction: row;justify-content: space-between;">
                <p> <b> Cantidad del Pedido:{{this.quantity}} </b> </p>
                <p> <b> Stock del Proveedor:{{this.product.stock}} </b> </p>
            </div>
            <div style="display: flex; flex-direction: row;justify-content: space-between;">
                <p> <b> Precio x Unidad:{{this.product.price}}USD </b> </p>
            </div>
            <button id="button-delete-carrito-{{@index}}" type="submit">Eliminar Carrito</button>
        </div>
    {{/each}}
</div>
<button id="button-pay" style="margin-top: 20px;">Comprar</button>

<script>
    const button = document.querySelector('#button-pay');
    const formSubmit = document.querySelector('#form-delete-carrito');
    const cid = "{{data._id}}";

    button.addEventListener('click', async () => {
        //const cid = "{{data._id}}";
        console.log("CLICK")
        try {
            const res = await fetch(`/api/carts/${cid}/purchase`, {method: 'POST'});
            const data = await res.json();
            console.log(data);
            window.location.href = data.init_point;
        }catch(e) {
            console.error(e)
        }
        
   });

    {{#each data.products}}
        document.querySelector("#button-delete-carrito-{{@index}}").addEventListener('click', () => { 
                fetch(`/api/carts/${cid}/product/{{this.product._id}}`, {method: 'DELETE'}).then(() => {
                alert('Se Elimino con exito');
                window.location.reload();
            }).catch(e => {
                alert('No se agrego al carrito');
                console.log(e);
            })
        })
    {{/each}}

   
</script>